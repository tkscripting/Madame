(function() {
    'use strict';

    // ========== RUNWAY CHECK ==========
    let matchesFound = false;

    function checkForRunway() {
        const paragraphs = document.querySelectorAll('.MuiTypography-root.MuiTypography-body2.css-1vrac05');
        let matched = false;

        paragraphs.forEach(paragraph => {
            const text = paragraph.textContent.trim();
            if ((text.toUpperCase().includes("RUNWAY") || text.toUpperCase().includes("LOOK"))) {
                if (!paragraph.parentElement.querySelector('.runway-check-message')) {
                    const newElement = document.createElement('p');
                    newElement.className = 'runway-check-message';
                    newElement.style.fontWeight = 'bold';
                    newElement.style.margin = '0';
                    newElement.style.color = 'red';
                    newElement.style.fontSize = '0.9em';
                    newElement.style.whiteSpace = 'nowrap';
                    newElement.textContent = 'Check for Runway';
                    paragraph.parentNode.insertBefore(newElement, paragraph.nextSibling);
                }
                matched = true;
            }
        });

        if (matched && !matchesFound) {
            matchesFound = true;
            runwayObserver.disconnect();
        }
    }

    const runwayObserver = new MutationObserver(() => {
        checkForRunway();
    });

    runwayObserver.observe(document.body, { childList: true, subtree: true });

    window.addEventListener('load', () => {
        checkForRunway();
        findMatches();
    });

    // ========== MATCHING CHECK ==========
    function findMatches() {
        const headerEl = document.querySelector('.MuiTypography-root.MuiTypography-subtitle1.MuiTypography-noWrap.css-uznm26');
        if (headerEl) {
            const headerText = headerEl.textContent.trim();
            if (headerText.includes('FW') || headerText.includes('FJ')) {
                return;
            }
        }

        const items = Array.from(document.querySelectorAll('.MuiBox-root.css-0'));
        const data = [];

        items.forEach((box, index) => {
            const brandEl = box.querySelector('.css-biu9sh');
            const colorEl = box.querySelector('.MuiTypography-root.MuiTypography-body2.css-1pngg4p');
            const descEl = box.querySelector('.MuiTypography-root.MuiTypography-body2.css-1vrac05');
            const vidEl = box.querySelector('.css-1nyh8gd');

            if (brandEl && colorEl && descEl && vidEl) {
                const brand = brandEl.textContent.trim();
                const color = colorEl.textContent.trim();
                let vid = vidEl.textContent.trim();

                // Skip item if color is "unknown"
                if (color.toLowerCase() === 'unknown') {
                    return;
                }

                // Check if the VID contains multiple numbers, grab the larger one
                const vidNumbers = vid.split(' ').map(num => num.trim());
                if (vidNumbers.length > 1) {
                    const largerVid = vidNumbers.reduce((max, num) => (num.length > max.length ? num : max), "");
                    vid = largerVid;
                }

                data.push({
                    index,
                    box,
                    descContainer: descEl.parentElement,
                    brand,
                    color,
                    vid
                });
            }
        });

        data.forEach((item, i) => {
            const matches = data.filter((other, j) =>
                i !== j && item.brand === other.brand && item.color === other.color
            );

            if (matches.length > 0) {
                const alreadyAppended = item.descContainer.querySelector('.match-label');
                if (!alreadyAppended) {
                    const p = document.createElement('p');
                    p.textContent = 'Possible Match';
                    p.className = 'match-label';
                    p.style.color = '#a64ac9';
                    p.style.margin = '4px 0 0 0';
                    p.style.fontWeight = 'bold';
                    item.descContainer.appendChild(p);
                }

                const existingVids = Array.from(item.descContainer.querySelectorAll('.match-vid')).map(el => el.textContent);

                matches.forEach(match => {
                    if (!existingVids.includes(match.vid)) {
                        const vidLine = document.createElement('p');
                        vidLine.textContent = match.vid;
                        vidLine.className = 'match-vid';
                        vidLine.style.color = '#a64ac9';
                        vidLine.style.margin = '0';
                        vidLine.style.fontSize = '0.8em';
                        item.descContainer.appendChild(vidLine);
                    }
                });
            }
        });
    }

    const matchObserver = new MutationObserver(() => {
        findMatches();
    });

    matchObserver.observe(document.body, { childList: true, subtree: true });

})();
